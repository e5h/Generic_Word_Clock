/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~
 * NAME:
 *      lib_timer.c
 *
 * PURPOSE:
 *      Source file corresponding to "lib_timer.h", defining the common timer
 *      routines for the given target.
 *
 * DEPENDENCIES:
 *      lib_timer.h
 *
 *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*
 * (C) Andrew Bright 2023, github.com/e5h
 *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/

/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*][ Feature Switches ][~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/

#define USES_EXTERNAL_TICK

/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*][ Include Files ][*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/

#include "lib_timer.h"

/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*][ LOCAL : Constants and Types ][*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/

/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*][ LOCAL : Variables ][*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/

volatile UINT64 TIMER_tickms = 0;

/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*][ LOCAL : Function Prototypes ][*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/

/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*][ Function Definitions ][~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/

/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~
 * NAME IN ENGLISH:
 *      "Update the TIMER_tickms variable"
 *
 * DESCRIPTION:
 *      Adds one millisecond to the TIMER_tickms variable.
 *
 * INPUTS:
 *      none
 *
 * OUTPUTS:
 *      none
 *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
extern void TIMER_tickMsUpdate()
{
    TIMER_tickms++;
}

/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~
 * NAME IN ENGLISH:
 *      "Create a countdown timer held in a 64-bit unsigned integer"
 *
 * DESCRIPTION:
 *      Returns a value which represents the current timestamp with a duration
 *      added. Both of these numbers are converted to milliseconds, and can
 *      be checked against the current timestamp to tell if the timer expired.
 *
 * INPUTS:
 *      (UINT64) duration of the timer in milliseconds
 *
 * OUTPUTS:
 *      (UINT64) current timestamp + duration in milliseconds
 *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
extern UINT64 TIMER_timerStartMs( UINT64 duration_ms_U64 )
{
    UINT64 current_ms_U64;

#ifdef USES_EXTERNAL_TICK
    current_ms_U64 = TIMER_tickms;
#else
    current_ms_U64 = ( ( xTaskGetTickCount() * 1000 ) / configTICK_RATE_HZ );
#endif

    return ( current_ms_U64 + duration_ms_U64 );
}

/*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~
 * NAME IN ENGLISH:
 *      "Check if a countdown timer has expired"
 *
 * DESCRIPTION:
 *      Checks to see if a provided countdown timer has expired when compared
 *      with the current time.
 *
 * INPUTS:
 *      (UINT64) timestamp created by "TIMER_downTimerStartMs"
 *
 * OUTPUTS:
 *      (BOOL) whether the timer has expired or not
 *~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*/
extern BOOL TIMER_timerExpiredMs( UINT64 timestamp_ms_U64 )
{
    UINT64 current_ms_U64;

#ifdef USES_EXTERNAL_TICK
    current_ms_U64 = TIMER_tickms;
#else
    current_ms_U64 = ( ( xTaskGetTickCount() * 1000 ) / configTICK_RATE_HZ );
#endif

    if( ( current_ms_U64 < timestamp_ms_U64 ) )
    {
        return FALSE;
    }
    else
    {
        return TRUE;    /* Timer has expired */
    }
}